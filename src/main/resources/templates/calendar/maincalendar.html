<!DOCTYPE html>
<html lang="kr" xmlns:sec="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이번 달 달력</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .navbar {
            transition: background-color 0.3s, color 0.3s;
        }
        .calendar {
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.3s;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.3s, color 0.3s;
        }
        .calendar-header h2 {
            margin: 0;
        }
        .calendar-header button {
            border: none;
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .calendar-header button:disabled {
            background-color: #ccc;
        }
        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-gap: 1px;
        }
        .calendar-day {
            padding: 10px;
            text-align: right;
            border: 1px solid #ddd;
            box-sizing: border-box;
            cursor: pointer;
            position: relative;
            aspect-ratio: 1; /* 날짜 칸 정사각형 유지 */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .calendar-day-header {
            font-weight: bold;
            text-align: center;
            padding: 5px 0;
            aspect-ratio: 3; /* 요일 칸의 비율 조정 */
        }
        .calendar-day:hover {
            background-color: #e7f1ff;
        }
        .calendar-day.selected {
            background-color: #007bff;
            color: white;
        }
        .calendar-day.today {
            background-color: #ffffe0; /* 옅은 노란색 배경 */
        }
        .calendar-day .event-titles {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 0.75em;
            color: #007bff;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .nav-tabs .nav-link {
            color: #007bff;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        /* 다크 모드 스타일 */
        .dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        .dark-mode .navbar {
            background-color: #333;
            color: #e0e0e0;
        }
        .dark-mode .calendar {
            border-color: #444;
        }
        .dark-mode .calendar-header {
            background-color: #333;
            color: #e0e0e0;
        }
        .dark-mode .calendar-header button {
            background-color: #555;
        }
        .dark-mode .calendar-day {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border-color: #333;
        }
        .dark-mode .calendar-day:hover {
            background-color: #333;
        }
        .dark-mode .calendar-day.selected {
            background-color: #007bff;
            color: #fff;
        }
        .dark-mode .calendar-day.today {
            background-color: #2a2a2a;
        }
        .dark-mode .calendar-day .event-titles {
            color: #007bff;
        }
        .dark-mode .nav-tabs .nav-link {
            color: #e0e0e0;
        }
        .dark-mode .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: #fff;
        }
        /* 다크 모드에서 팝업 창 */
        .dark-mode .modal-content {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        .dark-mode .form-control {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        .dark-mode .form-check-label {
            color: #e0e0e0;
        }
        .dark-mode .modal-header, .dark-mode .modal-footer {
            border-color: #444;
        }
        .dark-mode .modal-header .close {
            color: #e0e0e0;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-light">
    <div class="ml-auto d-flex">
        <a class="navbar-brand mr-3" href="#" th:text="${#authentication.principal.name}">님의 캘린더</a>
        <a class="nav-link" sec:authorize="isAuthenticated()" th:href="@{/member/logout.do}">
            로그아웃
        </a>
        <button id="toggleModeButton" class="btn btn-secondary ml-2">◐</button>
    </div>
</nav>

<div class="calendar">
    <div class="calendar-header">
        <button id="prevMonth">이전</button>
        <h2 id="monthYear"></h2>
        <button id="nextMonth">다음</button>
    </div>
    <div class="calendar-body" id="calendarBody">
        <!-- 달력의 날짜들이 여기에 표시됩니다 -->
    </div>
</div>

<!-- 일정 및 루틴 추가 모달 -->
<div class="modal fade" id="routineModal" tabindex="-1" role="dialog" aria-labelledby="routineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="routineModalLabel">일정/루틴 추가</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="schedule-tab" data-toggle="tab" href="#schedule" role="tab" aria-controls="schedule" aria-selected="true">일정</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="routine-tab" data-toggle="tab" href="#routine" role="tab" aria-controls="routine" aria-selected="false">루틴</a>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <!-- 일정 추가 탭 -->
                    <div class="tab-pane fade show active" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                        <form id="scheduleForm">
                            <div class="form-group">
                                <label for="scheduleTitle">일정 제목</label>
                                <input type="text" class="form-control" id="scheduleTitle" required>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="allDay">
                                <label class="form-check-label" for="allDay">하루 종일</label>
                            </div>
                            <div class="form-group">
                                <label for="scheduleStartDate">시작 날짜</label>
                                <input type="date" class="form-control" id="scheduleStartDate" required>
                            </div>
                            <div class="form-group">
                                <label for="scheduleEndDate">종료 날짜</label>
                                <input type="date" class="form-control" id="scheduleEndDate" required>
                            </div>
                            <div class="form-group">
                                <label for="scheduleParticipants">참석자</label>
                                <input type="text" class="form-control" id="scheduleParticipants">
                            </div>
                            <label for="scheduleLocation">장소</label>
                            <input type="text" class="form-control" id="scheduleLocation">
                    </div>
                    </form>
                </div>
                <!-- 루틴 추가 탭 -->
                <div class="tab-pane fade" id="routine" role="tabpanel" aria-labelledby="routine-tab">
                    <form id="routineForm">
                        <div class="form-group">
                            <label for="routineTitle">루틴 제목</label>
                            <input type="text" class="form-control" id="routineTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="routineStartDate">시작 날짜</label>
                            <input type="date" class="form-control" id="routineStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="routineEndDate">종료 날짜</label>
                            <input type="date" class="form-control" id="routineEndDate" required>
                        </div>
                        <div class="form-group">
                            <label for="routinePattern">반복 패턴</label>
                            <select class="form-control" id="routinePattern">
                                <option value="daily">매일</option>
                                <option value="weekly">매주</option>
                                <option value="monthly">매월</option>
                                <option value="yearly">매년</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="routineDetails">루틴 내용</label>
                            <textarea class="form-control" id="routineDetails" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="routineTime">시간</label>
                            <input type="time" class="form-control" id="routineTime">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="manualEntry">
                            <label class="form-check-label" for="manualEntry">수동 등록</label>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            <button type="button" class="btn btn-primary" id="saveButton">저장</button>
        </div>
    </div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
      const calendarBody = document.getElementById("calendarBody");
      const monthYear = document.getElementById("monthYear");
      const today = new Date();
      let currentMonth = today.getMonth();
      let currentYear = today.getFullYear();
      const eventMap = {};  // 이벤트를 날짜별로 저장할 Map

      // 서버에서 모든 이벤트를 가져오는 함수
      async function fetchEvents() {
          try {
              const response = await fetch('/api/events');
              const events = await response.json();
              events.forEach(ev => {
                  const eventDate = new Date(ev.startDate).getDate();
                  if (!eventMap[eventDate]) {
                      eventMap[eventDate] = [];
                  }
                  eventMap[eventDate].push(ev.title);
              });
              generateCalendar(currentMonth, currentYear);
          } catch (error) {
              console.error('이벤트를 가져오는 중 오류 발생:', error);
          }
      }

      function generateCalendar(month, year) {
          calendarBody.innerHTML = "";

          const firstDay = new Date(year, month).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];
          monthYear.textContent = `${year}년 ${monthNames[month]}`;

          const daysOfWeek = ["일", "월", "화", "수", "목", "금", "토"];
          daysOfWeek.forEach(day => {
              const dayHeader = document.createElement("div");
              dayHeader.className = "calendar-day-header";
              dayHeader.textContent = day;
              calendarBody.appendChild(dayHeader);
          });

          for (let i = 0; i < firstDay; i++) {
              const emptyCell = document.createElement("div");
              emptyCell.className = "calendar-day empty";
              calendarBody.appendChild(emptyCell);
          }

          for (let date = 1; date <= daysInMonth; date++) {
              const dateCell = document.createElement("div");
              dateCell.className = "calendar-day";
              dateCell.textContent = date;

              if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                  dateCell.classList.add("today");
              }

              if (eventMap[date]) {
                  const eventTitles = document.createElement("div");
                  eventTitles.className = "event-titles";
                  eventTitles.textContent = eventMap[date].join(', ');
                  dateCell.appendChild(eventTitles);
              }

              dateCell.addEventListener("click", function () {
                  $('#routineModal').modal('show');
                  // 현재 클릭한 날짜를 글로벌 변수로 설정 (필요시)
                  window.selectedDate = date;
              });

              calendarBody.appendChild(dateCell);
          }
      }

      document.getElementById("prevMonth").addEventListener("click", function () {
          currentMonth--;
          if (currentMonth < 0) {
              currentMonth = 11;
              currentYear--;
          }
          generateCalendar(currentMonth, currentYear);
      });

      document.getElementById("nextMonth").addEventListener("click", function () {
          currentMonth++;
          if (currentMonth > 11) {
              currentMonth = 0;
              currentYear++;
          }
          generateCalendar(currentMonth, currentYear);
      });

      document.getElementById("saveButton").addEventListener("click", async function () {
          const scheduleTitle = document.getElementById("scheduleTitle").value;
          const scheduleStartDate = new Date(document.getElementById("scheduleStartDate").value);
          const scheduleEndDate = new Date(document.getElementById("scheduleEndDate").value);

          if (scheduleTitle && !isNaN(scheduleStartDate) && !isNaN(scheduleEndDate)) {
              const startDate = scheduleStartDate.getDate();
              if (!eventMap[startDate]) {
                  eventMap[startDate] = [];
              }
              eventMap[startDate].push(scheduleTitle);

              // 서버에 새로운 이벤트 저장 요청
              try {
                  await fetch('/api/events', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          title: scheduleTitle,
                          startDate: scheduleStartDate.toISOString().split('T')[0],
                          endDate: scheduleEndDate.toISOString().split('T')[0],
                          allDay: document.getElementById("allDay").checked ? 1 : 0,
                          // 필요한 다른 필드 추가
                      }),
                  });
              } catch (error) {
                  console.error('이벤트 저장 중 오류 발생:', error);
              }

              generateCalendar(currentMonth, currentYear);
              $('#routineModal').modal('hide');
          }
      });

      fetchEvents();  // 페이지 로드 시 이벤트 가져오기
  });


</script>
</body>
</html>

